{% extends "base-layout.njk" %}
{% from "breadcrumb.njk" import breadcrumb %}

{% block content %}
<style>
.par-stats-table {
  display: grid;
  grid-template-columns: 1fr;
  row-gap: 2px;
  margin-bottom: 4rem;
}
.par-stats-scroll {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  margin-bottom: 4rem;
}
div.par-stats-entry.dark-stripe {
  background-color: #EEE;
}
.par-stats-entry {
  display: grid;
  grid-template-columns: minmax(320px, 3fr) repeat(5, minmax(140px, 1fr));
  min-height: 2.4rem;
  min-width: 1020px;
}
.par-stats-entry.header {
    font-weight: bold;
    font-size: 1rem;
    background-color: #CCCCFF;
    min-height: 4.2rem;
}
.sort-tab.selected {
    background-color: #BBBBEE;
}
.par-stats-entry.header div {
    padding-top: 0.5rem;
    padding-bottom: 0.5rem;
    align-items: flex-start;
}
.par-stats-entry  div {
    padding-left: 4px;
    display: flex;
    align-items: center;
}
.par-stats-entry    .speedlify-score {
      font-size: 0.75rem;
      height: 2.0em;
      min-width: 2.0em;
      vertical-align: middle;
}
.par-stats-entry  div.page-name {
    vertical-align: middle;
    padding-top: 0;
    font-size: 0.9rem;
    overflow: hidden;
}
.par-stats-entry .table-cell.date-cell {
    font-size: 0.85rem;
    padding-top: 0;
}
.sort-tab:not(:last-child) {
  border-right: 2px solid rgba(0,0,0,0.2);
}
@media (max-width: 1200px) {
  .par-stats-entry {
    grid-template-columns: minmax(280px, 3fr) repeat(5, minmax(120px, 1fr));
    min-width: 900px;
  }
}
@media (max-width: 767px) {
  .par-stats-entry {
    grid-template-columns: minmax(220px, 3fr) repeat(5, minmax(110px, 1fr));
    min-width: 780px;
  }
  .par-stats-entry.header {
    font-size: 0.95rem;
    min-height: 3.8rem;
  }
}
</style>

  <div id="page-container" class="page-container-ds">
    {{ breadcrumb(id, title, collections) }}
    <main id="body-content">
      <div class="single-column">
        {% if previewimage %}
          <img src="/{{ previewimage }}" class="mb-2" alt="" />
        {% endif %}
        <h1 class="page-title">{{ title | safe }}</h1>
        <article id="post-{{ page.fileSlug }}">       
          <div class="category-label">{{ category | safe }}</div>
          <div class="entry-content">
            {{ content | safe }}
          </div>

            {# beg par table #}

            {# loop thru keys in the performance array (into var key) #}
                {# display key, performance[key].lighthouse.performance, performance[key].lighthouse.accessibility * 100, readability[key].readability.ari #}
            <div class="par-stats-scroll">
              <div class="par-stats-entry header">
                  <div class="sort-tab selected" data-sort-col="0" >Page ↑</div>
                  <div class="sort-tab" data-sort-col="1" >Performance</div>
                  <div class="sort-tab" data-sort-col="2"  >Accessibility</div>
                  <div class="sort-tab" data-sort-col="3"  >Readability (ari)</div>
                  <div class="sort-tab" data-sort-col="4"  >Last Modified</div>
                  <div class="sort-tab" data-sort-col="5"  >Last Reviewed</div>
                </div>
              <div class="par-stats-table">
              {% for item in collections.all %}
                  <div class="par-stats-entry">
                  <div class="table-cell page-name" data-col-idx="0" data-sort-val="{{item.url}}"><a href="{{item.url}}?par=1">{{item.url}}</a></div>
                  <div class="table-cell" data-col-idx="1" data-sort-val="{{item.data.lighthouse.performance.displayScore}}"><span class="speedlify-score {{item.data.lighthouse.performance.displayClass}}">{{item.data.lighthouse.performance.displayScore}}</span></div>
                  <div class="table-cell" data-col-idx="2" data-sort-val="{{item.data.lighthouse.accessibility.displayScore}}"><span class="speedlify-score {{item.data.lighthouse.accessibility.displayClass}}">{{item.data.lighthouse.accessibility.displayScore}}</span></div>
                  <div class="table-cell" data-col-idx="3" data-sort-val="{{item.data.readability.displayScore}}"><span data-ari-score="{{item.data.readability.ari}}" class="speedlify-score {{item.data.readability.displayClass}}">{{item.data.readability.displayScore}}</span></div>
                  <div class="table-cell date-cell" data-col-idx="4" data-sort-val="{{item.data.lighthouse.lastmod.timestamp}}">
                    <span{% if item.data.lighthouse.lastmod.tooltip %} title="{{item.data.lighthouse.lastmod.tooltip}}"{% endif %}>{{item.data.lighthouse.lastmod.displayDate or "—"}}</span>
                  </div>
                  <div class="table-cell date-cell" data-col-idx="5" data-sort-val="{{item.data.lighthouse.lastreviewed.timestamp}}">
                    <span{% if item.data.lighthouse.lastreviewed.tooltip %} title="{{item.data.lighthouse.lastreviewed.tooltip}}"{% endif %}>{{item.data.lighthouse.lastreviewed.displayDate or "—"}}</span>
                  </div>
                  </div>

              {% endfor %}

              </div>
            </div>
            {# end par table #}


        </article>
        <span class="return-top hidden-print"></span>
      </div>
    </main>
  </div>

<script>
  var default_sorts = [0,0,0,0,0,0]; // ascending/descending
  var sort_states = [ 0,0,0,0,0,0 ];
  var header_labels = ['Page','Performance','Accessibility','Readability (ari)','Last Modified','Last Reviewed'];
  var active_sort_col = 0;
  var active_sort_dir = 0;
  var string_sort = false;

  function performSort(cur_sort_col, cur_sort_dir) {
    console.log("Sorting",header_labels[cur_sort_col], cur_sort_dir? "Descending": "Ascending");
    // for each div.sort-tab
    var divs = document.getElementsByClassName('sort-tab');
    for (var i = 0; i < divs.length; i++) {
      var hDiv = divs[i];
      var hCol = hDiv.getAttribute('data-sort-col');
      divs[i].innerHTML = header_labels[i] + (hCol == cur_sort_col? " "+(cur_sort_dir==1?"↓":"↑") : "");
      // set selected class on hDiv if it's cur_sort_col
      if (hCol == cur_sort_col) {
        hDiv.classList.add('selected');
      } else {
        hDiv.classList.remove('selected');
      }
    }


    // sort the table
    // create a list of row-indices, paired with sort keys
    // sort it, then use the resulting row-indices to assign order tags to the par-stats-entry classes
    var table = document.getElementsByClassName('par-stats-table')[0];
    var rows = table.getElementsByClassName('par-stats-entry');
    row_indices = [];
    for (var i = 0; i < rows.length; i++) {
      var divs = rows[i].getElementsByClassName('table-cell');
      row_indices.push([i,divs[cur_sort_col].getAttribute('data-sort-val')]);
    }
    row_indices.sort(function(a,b) {
    // if column==0, sort by name rather than numerically
      if (string_sort) {
        if (cur_sort_dir == 0) {
          return a[1].localeCompare(b[1]);
        }
        else {
          return b[1].localeCompare(a[1]);
        }
      } else {
        var aVal = Number(a[1]);
        var bVal = Number(b[1]);
        var aMissing = Number.isNaN(aVal);
        var bMissing = Number.isNaN(bVal);
        if (aMissing && bMissing) return 0;
        // Keep blanks at the bottom for numeric/date sorts.
        if (aMissing) return 1;
        if (bMissing) return -1;
        if (cur_sort_dir == 0) {
          return aVal - bVal; // ascending
        } else {
          return bVal - aVal; // descending
        }
      }
    });
    for (var i = 0; i < row_indices.length; i++) {
      // for each row, set order: i to the element
      rows[row_indices[i][0]].style.order = i;
      // toggle class 'dark-stripe' if i is odd
      if (i % 2 == 1) {
        rows[row_indices[i][0]].classList.add('dark-stripe');
      }
      else {
        rows[row_indices[i][0]].classList.remove('dark-stripe');
      }
    }
  }

  function sortTabClickHandler(e) {
    const sortCol = e.target.getAttribute('data-sort-col');
    const sortVal = e.target.getAttribute('data-sort-val');
    if (sortCol == active_sort_col) {
      sort_states[sortCol] = (sort_states[sortCol] + 1) % 2;
    }
    active_sort_col = sortCol;
    active_sort_dir = (sort_states[active_sort_col] + default_sorts[active_sort_col]) % 2;
    string_sort = active_sort_col == 0;
    // get div
    performSort(active_sort_col, active_sort_dir);
  }
  // handlers for clicking on sort-tab
  var divs = document.getElementsByClassName('sort-tab');
  for (var i = 0; i < divs.length; i++) {
    divs[i].addEventListener('click', sortTabClickHandler);
  }
  performSort(active_sort_col, active_sort_dir);


</script>

{% endblock %}
